---
jupyter:
  jupytext:
    formats: ipynb,md
    text_representation:
      extension: .md
      format_name: markdown
      format_version: '1.3'
      jupytext_version: 1.16.1
  kernelspec:
    display_name: ds-cmr-flooding-support
    language: python
    name: ds-cmr-flooding-support
---

# Jan 2025

```python
%load_ext jupyter_black
%load_ext autoreload
%autoreload 2
```

```python
import calendar

import matplotlib.pyplot as plt

from src.datasources import ecmwf, watersheds
from src import blob
from src.utils import upsample_dataarray
from src.constants import *
```

## Load data

```python
gdf_lc = watersheds.load_logone_chari()
```

```python
gdf_lc.plot()
```

```python
valid_months = [6, 7]
issue_months = [1]
ec = ecmwf.open_ecmwf_rasters_from_blob(
    issue_months=issue_months, valid_months=valid_months
)
```

```python
ec
```

## Process SEAS5

```python
ec_year = ec.sum(dim="leadtime").squeeze(drop=True)
ec_year_up = upsample_dataarray(ec_year, lat_dim="y", lon_dim="x")
ec_clip = ec_year_up.rio.clip(gdf_lc.geometry)
```

```python
ec_clip
```

```python
ec_clip = ec_clip.persist()
```

```python
ec_mean = ec_clip.mean(dim=["x", "y"])
```

```python
ec_df = ec_mean.to_dataframe("mean")["mean"].reset_index()
```

```python
ec_df["rank"] = ec_df["mean"].rank()
ec_df["percentile"] = ec_df["mean"].rank(pct=True)
ec_df
```

```python
blob_name = f"{blob.PROJECT_PREFIX}/processed/seas5/cmr_seas5_i{issue_months}_v{valid_months}_logone-chari_ranks.csv"
```

```python
blob_name
```

```python
blob.upload_csv_to_blob(blob_name, ec_df)
```

## Plotting

```python
ec_adm = ec_clip * 30
```

```python
ec_adm.isel(year=0).plot()
```

```python
ec_anom = (ec_adm - ec_adm.mean(dim="year")) / ec_adm.mean(dim="year") * 100
```

```python
issue_mo_fr = FRENCH_MONTHS.get(calendar.month_abbr[issue_months[0]])
min_mo_fr = FRENCH_MONTHS.get(calendar.month_abbr[min(valid_months)])
max_mo_fr = FRENCH_MONTHS.get(calendar.month_abbr[max(valid_months)])
```

```python
current_year = ec_df["year"].max()
```

```python
fig, ax = plt.subplots(figsize=(10, 5), dpi=300)
gdf_lc.boundary.plot(ax=ax, color="white", linewidth=1)
ec_adm.sel(year=current_year).plot(
    ax=ax, cbar_kwargs={"label": "Précipitations totales prévues (mm)"}
)
ax.axis("off")

title_text = (
    f"Prévisions ECMWF {current_year} Logone et Chari\n"
    f"mois de publication: {issue_mo_fr},\npériode d'interêt: {min_mo_fr}-{max_mo_fr}"
)
ax.set_title(title_text)

fig, ax = plt.subplots(figsize=(10, 5), dpi=300)
gdf_lc.boundary.plot(ax=ax, color="k", linewidth=1)
ec_anom.sel(year=current_year).plot(
    ax=ax,
    cmap="RdBu",
    vmax=float(ec_anom.sel(year=current_year).max()),
    vmin=-float(ec_anom.sel(year=current_year).max()),
    cbar_kwargs={"label": "Anomalie de précipitations totales prévues (%)"},
)
ax.axis("off")
ax.set_title(title_text)

df_adm = (
    ec_adm.mean(dim=["x", "y"]).to_dataframe("tprate")["tprate"].reset_index()
)

thresh = df_adm["tprate"].quantile(2 / 3)

fig, ax = plt.subplots(dpi=300)
df_adm.plot(x="year", y="tprate", ax=ax, legend=False, linewidth=1)
ax.plot([current_year], [df_adm.iloc[-1]["tprate"]], ".r")
ax.annotate(
    current_year,
    xy=(current_year, df_adm.iloc[-1]["tprate"]),
    color="red",
    ha="center",
    va="top",
)
ax.axhline(y=thresh, color="grey", linestyle="--")
ax.annotate(
    " seuil\n 1-an-sur-3",
    xy=(current_year + 2, thresh),
    color="grey",
    ha="left",
    va="center",
)
ax.set_xlim(left=1981, right=current_year + 2)
ax.set_xlabel("Année")
ax.set_ylabel(
    "Précipitations totales prévues,\nmoyenne sur tout le bassin (mm)"
)
ax.set_title(title_text)
ax.spines["top"].set_visible(False)
ax.spines["right"].set_visible(False)
```

```python
df_adm["rank"] = df_adm["tprate"].rank(ascending=False).astype(int)
df_adm["percentile"] = df_adm["tprate"].rank(ascending=True, pct=True)
df_adm["rp"] = (1 + len(df_adm)) / df_adm["rank"]
```

```python
df_adm.sort_values("rp")
```

```python
fig, ax = plt.subplots(dpi=300)
df_adm.sort_values("rp").plot(x="rp", y="tprate", ax=ax)

current_rp, current_val, current_per = df_adm.set_index("year").loc[
    current_year
][["rp", "tprate", "percentile"]]
ax.plot(current_rp, current_val, "r.")
annotation = (
    f" {current_year}:\n Période ret. = {current_rp:.1f} ans\n "
    f"Valeur = {current_val:.0f} mm\n Centile = {current_per:.2f}"
)
ax.annotate(
    annotation,
    (current_rp, current_val),
    color="red",
    va="top",
    ha="left",
)
ax.set_title(
    f"Période de retour de prévisions ECMWF Logone et Chari\n"
    f"mois de publication: {issue_mo_fr}, mois d'intérêt: {min_mo_fr}-{max_mo_fr}"
)
ax.set_xlabel("Période de retour (ans)")
ax.set_ylabel(
    "Précipitations totales prévues,\nmoyenne sur tout le bassin (mm)"
)
ax.spines["top"].set_visible(False)
ax.spines["right"].set_visible(False)
ax.autoscale(enable=True, axis="both", tight=True)
# ax.set_xlim(1, 10)
# ax.set_ylim(top=105)
ax.get_legend().remove()
```
